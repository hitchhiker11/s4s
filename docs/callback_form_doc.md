**REST-endpoint**: `/api/callback`
Этот маршрут поддерживает два метода:

* **POST** – создание новой заявки (любой формы, у которой в инфоблоке есть свойства).
* **GET** – получение списка существующих заявок из указанного инфоблока.

---

## 1. POST `/api/callback` – создание новой заявки

**Описание**
Принимает в теле JSON, где свойство `fields` — ассоциативный массив «код\_свойства → значение». Каждый ключ внутри `fields` должен совпадать с кодом свойства конкретного инфоблока (например: `first_name`, `last_name`, `phone_number` и т. д.). Если вы хотите создать заявку сразу в другом инфоблоке, дополнительно передаётся параметр `iblock_id`.

**URL**

```
POST /api/callback
Content-Type: application/json
```

**Request Body**

```jsonc
{
  "iblock_id": 4,          // необязательно; по умолчанию 4
  "fields": {
    "first_name": "Иван",       // код свойства «Имя» (обязательно)
    "last_name": "Иванов",      // код свойства «Фамилия» (необязательно, если в инфоблоке не обязательное)
    "phone_number": "+79991234567" // код свойства «Номер телефона» (обязательно)
    // … любые другие ключи/значения свойств вашего инфоблока
  }
}
```

* `iblock_id` (int) — ID инфоблока, в который запишется заявка (по умолчанию 4).
* `fields` (object) — ассоциативный массив:

  * **обязательные**:

    * `first_name` (string) – код свойства «Имя» (необходимо, т. к. оно настроено обязательным).
    * `phone_number` (string) – код свойства «Номер телефона» (формат: `+7XXXXXXXXXX`).
  * **необязательные**:

    * `last_name` (string) – код свойства «Фамилия» (если в инфоблоке не обязательное, можно его не указывать).
    * любые другие поля, существующие в этом инфоблоке (например `comment`, `email` и т. д.).

**Пример запроса**

```
POST /api/callback
Content-Type: application/json

{
  "iblock_id": 4,
  "fields": {
    "first_name": "Иван",
    "last_name": "Иванов",
    "phone_number": "+79991234567"
  }
}
```

**Возможные ошибки**

* **400 Bad Request** – если:

  * тело запроса пустое или невалидный JSON;
  * нет ключа `fields` или он не массив;
  * не переданы обязательные свойства (`first_name` или `phone_number`);
  * неверный формат `phone_number` (ожидается `+7XXXXXXXXXX`);
  * ненайден указанный `iblock_id`.

**Успешный ответ (200 OK)**

```json
{
  "success": true,
  "id": 324,
  "message": "Заявка успешно создана"
}
```

* `success` (bool) – успешно ли прошло создание.
* `id` (int) – ID созданного элемента в инфоблоке.
* `message` (string) – информационное сообщение.

---

## 2. GET `/api/callback` – список заявок

**Описание**
Возвращает постраничный список элементов указанного инфоблока. В ответе:

* `fields` – базовые поля каждого элемента (`id`, `name`, `date_create`).
* `properties` – все свойства (код → значение), которые есть у элемента.

**URL**

```
GET /api/callback
Authorization: Bearer <JWT-token>    // если у вас включена авторизация (см. security)
```

**Query-параметры**

| Параметр    | Тип     | По умолчанию | Описание                                  |
| ----------- | ------- | ------------ | ----------------------------------------- |
| `iblock_id` | integer | 4            | ID инфоблока, откуда читать заявки.       |
| `limit`     | integer | 10           | Количество элементов на странице (1–100). |
| `page`      | integer | 1            | Номер страницы (начиная с 1).             |
| `sort`      | string  | `ID:DESC`    | Сортировка: `FIELD:asc` или `FIELD:desc`. |

**Пример запроса**

```
GET /api/callback?iblock_id=4&limit=5&page=1&sort=DATE_CREATE:DESC
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUz...
```

**Успешный ответ (200 OK)**

```json
{
  "success": true,
  "meta": {
    "total": 8,
    "page": 1,
    "limit": 10,
    "pages": 1
  },
  "data": [
    {
      "fields": {
        "id": 324,
        "name": "Заявка от Иван",
        "date_create": "04.06.2025 18:50:14"
      },
      "properties": {
        "first_name": "Иван",
        "last_name": "Иванов",
        "phone_number": "+79991234567"
      }
    },
    {
      "fields": {
        "id": 323,
        "name": "Заявка от Иван",
        "date_create": "04.06.2025 18:49:46"
      },
      "properties": {
        "first_name": "Иван",
        "last_name": "Иванов",
        "phone_number": "+79991234567"
      }
    },
    // … ещё элементы …
  ]
}
```

* `meta.total` – общее число элементов в инфоблоке.
* `meta.page` – текущая страница.
* `meta.limit` – лимит на страницу.
* `meta.pages` – общее количество страниц.
* `data` – массив объектов-элементов, где каждый элемент:

  * `fields.id` – ID элемента.
  * `fields.name` – наименование (мы формируем его как «Заявка от {first\_name}»).
  * `fields.date_create` – дата создания.
  * `properties` – все свойства элемента в виде `{код_свойства: значение}`.

**Возможные ошибки (400)**

* Неверный `iblock_id` (не найден инфоблок).
* Неверные значения `limit`, `page`, или `sort` (например, некорректный формат).
* Отсутствие или просроченный JWT-токен (если требуется авторизация).

---

## 3. Общие замечания

1. **Коды свойств**
   При создании заявки через POST вы должны точно указывать в `fields` те ключи, которые есть в инфоблоке.
   В вашем случае в инфоблоке настроены:

   * `first_name` – Имя (обязательно),
   * `last_name` – Фамилия (необязательно),
   * `phone_number` – Номер телефона (обязательно).
     Если добавить в инфоблок новое свойство, например `comment`, фронт может в POST сразу отправлять `"comment": "...“`, и оно сохранится.

2. **Авторизация**

   * Для GET требуется JWT-токен (заголовок `Authorization: Bearer <token>`).
   * Для POST / создание – авторизация необязательна (`auth.required => false`), но, при желании, вы можете включить требование токена в `routes/callback.php`.

3. **Формат даты**
   В ответах поле `date_create` возвращается в формате `DD.MM.YYYY HH:MM:SS` по локали Битрикса.

4. **Пагинация и сортировка**

   * `limit` (1…100) и `page` (≥ 1).
   * `sort=FIELD:asc|desc`. Часто используют `ID:DESC` (по убыванию) или `DATE_CREATE:DESC`.

5. **Ошибки**
   Все ошибки возвращаются в едином формате:

   ```json
   {
     "success": false,
     "error": {
       "code": 400,                 
       "message": "Описание ошибки" 
     }
   }
   ```

   где `code` – HTTP-статус, `message` – пояснение (например, «Не переданы обязательные поля», «Инфоблок не найден», «Невалидный JSON»).

---

### 4. Краткий чек-лист

* **Чтобы создать заявку**:

  1. Отправить `POST /api/callback`
  2. В JSON-теле обязательно указать:

     ```json
     {
       "iblock_id": 4,              // если хотите целиться в другой инфоблок
       "fields": {
         "first_name": "Иван",      // обязателен
         "phone_number": "+7XXXXXXXXXX", // обязателен
         // … дополнительные свойства по необходимости
       }
     }
     ```
  3. Если всё верно, вернётся:

     ```json
     { "success": true, "id": 324, "message": "Заявка успешно создана" }
     ```

* **Чтобы получить список заявок**:

  1. Отправить `GET /api/callback?limit=10&page=1&sort=ID:DESC`

     * Заголовок подписанного JWT (если в `routes` стоит `auth.required=true`).
  2. В ответ получите:

     ```json
     {
       "success": true,
       "meta": { "total": 8, "page": 1, "limit": 10, "pages": 1 },
       "data": [
         {
           "fields": {
             "id": 324,
             "name": "Заявка от Иван",
             "date_create": "04.06.2025 18:50:14"
           },
           "properties": {
             "first_name": "Иван",
             "last_name": "Иванов",
             "phone_number": "+79991234567"
           }
         },
         // … другие заявки
       ]
     }
     ```

Эта документация содержит всё необходимое для работы с ручкой `/api/callback`: какие параметры передавать, в каком формате, и какие ответы ждать.
