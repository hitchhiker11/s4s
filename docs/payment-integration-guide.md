# üöÄ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–ª–∞—Ç—ã –ë–∏—Ç—Ä–∏–∫—Å

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –ë–∏—Ç—Ä–∏–∫—Å** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –∏ —Ñ–æ—Ä–º –æ–ø–ª–∞—Ç—ã –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–¥–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL.

### üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±—ç–∫–µ–Ω–¥–µ (`OrderNew.php`)

#### –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```php
// –°–∞–º–æ–¥–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL –†–æ–±–æ–∫–∞—Å—Å—ã
$directPaymentUrl = $this->buildRobokassaUrl($payment, $service);
```

#### –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
```php
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–Ω–æ–≥–æ API –ë–∏—Ç—Ä–∏–∫—Å
$paySystemService = PaySystem\Manager::getObjectById($payment->getPaymentSystemId());

if ($paySystemService->getField('NEW_WINDOW') === 'N') {
    // –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è
    $initResult = $paySystemService->initiatePay(
        $payment, 
        $context->getRequest(), 
        PaySystem\BaseServiceHandler::STRING
    );
    $paymentForm = $initResult->getTemplate();
} else {
    // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    $initResult = $paySystemService->initiatePay(
        $payment, 
        $context->getRequest(), 
        PaySystem\BaseServiceHandler::CURL
    );
    $directPaymentUrl = $initResult->getTemplate();
}
```

### üéØ –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ API

```json
{
  "success": true,
  "data": {
    "order_id": 318,
    "payment_id": 42,
    "payment_system": "–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞",
    "payment_system_id": 3,
    "amount": 1500.00,
    "currency": "RUB",
    "payment_form": "<form>...</form>",           // –ï—Å–ª–∏ NEW_WINDOW='N'
    "direct_payment_url": "https://...",          // –ï—Å–ª–∏ NEW_WINDOW='Y'
    "new_window": true                            // –§–ª–∞–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
  }
}
```

---

## üåê –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### üîÑ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã

```javascript
const handlePayment = async () => {
  const response = await getPaymentForm(order_id);
  const { payment_form, direct_payment_url, new_window } = response.data;
  
  if (direct_payment_url) {
    // –ü—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –†–æ–±–æ–∫–∞—Å—Å–∞)
    if (new_window) {
      window.open(direct_payment_url, '_blank');
    } else {
      window.location.href = direct_payment_url;
    }
  } else if (payment_form) {
    // –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã
    const formContainer = document.createElement('div');
    formContainer.innerHTML = payment_form;
    document.body.appendChild(formContainer);
    
    const form = formContainer.querySelector('form');
    if (form) {
      if (new_window) form.target = '_blank';
      form.submit();
    }
  }
};
```

### üêõ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–í `development` —Ä–µ–∂–∏–º–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:

```javascript
{process.env.NODE_ENV === 'development' && (
  <div style={{ /* debug styles */ }}>
    <strong>Debug Info:</strong>
    <pre>{JSON.stringify(orderData, null, 2)}</pre>
  </div>
)}
```

---

## üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

### üè¶ –†–æ–±–æ–∫–∞—Å—Å–∞ (ID: 3)
- **NEW_WINDOW**: –æ–±—ã—á–Ω–æ `'Y'` 
- **–¢–∏–ø**: `direct_payment_url`
- **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: –ü—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ auth.robokassa.ru

### üí≥ –î—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º—ã
- **NEW_WINDOW**: –º–æ–∂–µ—Ç –±—ã—Ç—å `'Y'` –∏–ª–∏ `'N'`
- **–¢–∏–ø**: `payment_form` –∏–ª–∏ `direct_payment_url`
- **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: `/test-payment`

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
- ‚úÖ Email-—Å—Å—ã–ª–∫–∏ `/cart/?order_id=XXX`
- ‚úÖ –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ `/payment?order_id=XXX`
- ‚úÖ –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã API

```bash
# –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
GET /api/order?action=get_status&order_id=318

# –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã
GET /api/order?action=get_payment_form&order_id=318
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–í `development` —Ä–µ–∂–∏–º–µ –≤—Å–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤:
- –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
- Debug —Å–µ–∫—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã
- –õ–æ–≥–∏ API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
```
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –∑–∞–∫–∞–∑–µ:
$order->getPaymentCollection()->current()->getPaymentSystemId()
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã"
```
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –∞–¥–º–∏–Ω–∫–µ –ë–∏—Ç—Ä–∏–∫—Å:
/bitrix/admin/sale_pay_system.php
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
```
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ NEW_WINDOW –Ω–∞—Å—Ç—Ä–æ–π–∫—É:
- NEW_WINDOW='Y' ‚Üí direct_payment_url
- NEW_WINDOW='N' ‚Üí payment_form
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–æ–¥–Ω–æ–π API –ë–∏—Ç—Ä–∏–∫—Å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å  
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º –∏ –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –æ–∫–æ–Ω
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏

### ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** –≤ debug —Ä–µ–∂–∏–º–µ
2. **–£–±–µ–¥–∏—Ç–µ—Å—å** —á—Ç–æ –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –ë–∏—Ç—Ä–∏–∫—Å
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –Ω–∞ `/test-payment`
4. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å** –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: `/docs/payment-flow.md`

---

*–û–±–Ω–æ–≤–ª–µ–Ω–æ: 2024-01-15*  
*–í–µ—Ä—Å–∏—è: 2.0 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)* 