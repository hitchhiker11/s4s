# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –∫–æ—Ä–∑–∏–Ω—ã

```markdown
# üõí API –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FUSER_ID)
- **FUSER_ID** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ: `session_id + user_agent + ip + timestamp`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏ PHP: `$_SESSION['BX_SALE_FUSER']`
- **–°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î** —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–∞–±–ª–∏—Ü—É `b_sale_fuser`
- –ö–æ—Ä–∑–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `b_sale_basket` –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

### –ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
1. **–ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è FUSER_ID
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏**: ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PHP session –∏ cookie –±—Ä–∞—É–∑–µ—Ä–∞
3. **–ü—Ä—è–º–∞—è —Å–≤—è–∑–∫–∞ —Å –ë–î**: **–û–±—Ö–æ–¥ Sale —Å–æ–±—ã—Ç–∏–π** - –∑–∞–ø–∏—Å—å –Ω–∞–ø—Ä—è–º—É—é –≤ `b_sale_fuser` –∏ `b_sale_basket`
4. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫–æ—Ä–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Sale\Basket::loadItemsForFUser()`

### ‚ö° –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è
- **–û–±—Ö–æ–¥ SessionLocalStorageManager**: –ò–∑–±–µ–≥–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π Sale –º–æ–¥—É–ª—è
- **–ü—Ä—è–º—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã –±–µ–∑ –≤—ã–∑–æ–≤–∞ `$basket->save()`
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Å—Å–∏—é**: –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

## üì° API Endpoints

### üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
```http
GET /api/basket
```
**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `format` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* - —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (`full`, `compact`)

**–û—Ç–≤–µ—Ç:**
```json
{
  "meta": {
    "fuser_id": 3118093150,
    "site_id": "s1", 
    "format": "full",
    "request_time": "2025-05-28 19:06:06"
  },
  "basket": {
    "items": [
      {
        "id": 1862,
        "product_id": 8193,
        "name": "–ü–æ–ª–æ Eiger Tac Parabellum SS XL",
        "quantity": 2,
        "price": 3950,
        "total_price": 7900,
        "currency": "RUB",
        "weight": 0,
        "can_buy": true,
        "properties": []
      }
    ],
    "summary": {
      "count": 1,
      "quantity": 2,
      "total_price": 7900,
      "base_price": 7900,
      "weight": 0,
      "currency": "RUB",
      "fuser_id": 3118093150
    }
  }
}
```

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
```http
POST /api/basket
Content-Type: application/json

{
  "product_id": 8193,
  "quantity": 2,
  "properties": [
    {
      "CODE": "COLOR",
      "NAME": "–¶–≤–µ—Ç", 
      "VALUE": "–ö—Ä–∞—Å–Ω—ã–π"
    },
    {
      "CODE": "SIZE",
      "NAME": "–†–∞–∑–º–µ—Ä",
      "VALUE": "XL"
    }
  ]
}
```

**–ü–æ–ª—è:**
- `product_id` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)* - ID —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
- `quantity` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1)* - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
- `properties` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* - –º–∞—Å—Å–∏–≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤ —Ç–æ–≤–∞—Ä–∞

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```json
{
  "success": true,
  "message": "–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É",
  "data": {
    "success": true,
    "action": "added",
    "item": { 
      /* –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ */ 
            "id": 1867,
            "product_id": 8193,
            "name": "–ü–æ–ª–æ Eiger Tac Parabellum SS XL ASIA/L EUR (grey)",
            "quantity": 2,
            "price": 3950,
            "total_price": 7900,
            "currency": "RUB",
            "weight": "0.00",
            "can_buy": true,
            "properties": []
      },
    "basket_total": 
      { /* –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–µ */ 
            "count": 1,
            "quantity": 2,
            "total_price": 7900,
            "base_price": 7900,
            "weight": 0,
            "currency": "RUB",
            "fuser_id": 3118093150
      }
  }
}

```

### ‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
```http
PATCH /api/basket
Content-Type: application/json

{
  "basket_item_id": 1862,
  "quantity": 3
}
```

**–ü–æ–ª—è:**
- `basket_item_id` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)* - ID —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
- `quantity` *(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)* - –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (0 = —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä)

### ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
```http
DELETE /api/basket
Content-Type: application/json

{
  "basket_item_id": 1862
}
```

### üßπ –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
```http
DELETE /api/basket
Content-Type: application/json

{
  "clear_all": "Y"
}
```

## üõçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

### üìã –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```http
POST /api/order_create
Content-Type: application/json

{
  "name": "–ò–≤–∞–Ω",
  "surname": "–ü–µ—Ç—Ä–æ–≤", 
  "patronymic": "–°–µ—Ä–≥–µ–µ–≤–∏—á",
  "phone": "+7 (999) 123-45-67",
  "email": "ivan.petrov@example.com",
  "comment": "–î–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ 18:00",
  "payment_method": 1,
  "delivery_method": 1,
  "delivery_address": "–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1, –∫–≤. 10"
}
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- `name` - –∏–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- `phone` - —Ç–µ–ª–µ—Ñ–æ–Ω (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ 11 —Ü–∏—Ñ—Ä)
- `email` - email (–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- `surname` - —Ñ–∞–º–∏–ª–∏—è
- `patronymic` - –æ—Ç—á–µ—Å—Ç–≤–æ  
- `comment` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É
- `payment_method` - ID —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1)
- `delivery_method` - ID —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1)
- `delivery_address` - –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã**: –ö–æ—Ä–∑–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
3. **–°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: 
   - –ü–æ–∏—Å–∫ –ø–æ email –≤ `b_user`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–µ—Ä–µ–∑ `CUser::Add()`
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è (8 —Å–∏–º–≤–æ–ª–æ–≤)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É "–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏" (ID: 2)
4. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞**: `Sale\Order::create($siteId, $userId)`
5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–∫–∞–∑–∞**:
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (—Ñ–∏–∑.–ª–∏—Ü–æ)
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã: `$order->setBasket($basket)`
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∞–ª—é—Ç—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
6. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏**: 
   - –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ `ShipmentCollection`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EmptyDeliveryService –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
7. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–ª–∞—Ç—ã**: 
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `PaymentCollection`
   - –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
8. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ –∑–∞–∫–∞–∑–∞**:
   - Email, —Ç–µ–ª–µ—Ñ–æ–Ω, –§–ò–û —á–µ—Ä–µ–∑ `PropertyCollection`
   - –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
9. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: `$order->doFinalAction(true)` ‚Üí `$order->save()`
10. **–û—á–∏—Å—Ç–∫–∞**: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–µ—Å—Å–∏–∏

### –û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏:
```json
{
  "success": true,
  "message": "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω",
  "data": {
    "order_id": 123,
    "order_number": "00000123", 
    "total_price": 7900,
    "currency": "RUB", 
    "user_id": 456,
    "payment_url": "/payment/pay.php?ORDER_ID=123&PAYMENT_ID=789"
  }
}
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è
```
–ó–∞–ø—Ä–æ—Å API ‚Üí BasketBase ‚Üí –ü—Ä—è–º—ã–µ SQL ‚Üí –ë–î –ë–∏—Ç—Ä–∏–∫—Å
                ‚Üì
         –û–±—Ö–æ–¥ Sale —Å–æ–±—ã—Ç–∏–π
                ‚Üì 
    –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ PHP Session
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- **SessionLocalStorageManager**: –ü–æ–ª–Ω—ã–π –æ–±—Ö–æ–¥ —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã
- **FUSER —Å–æ–∑–¥–∞–Ω–∏–µ**: Fallback –º–µ—Ö–∞–Ω–∏–∑–º —á–µ—Ä–µ–∑ `createFuserDirectly()`
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã**: –ú–µ—Ç–æ–¥ `saveBasketWithoutEvents()` –∏–∑–±–µ–≥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–π
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ `/local/logs/fuser_debug.log`

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–í–∞–ª–∏–¥–∞—Ü–∏—è email**: `filter_var($email, FILTER_VALIDATE_EMAIL)`
- **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è SQL**: `$DB->ForSQL()` –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∫–∞—Ç–∞–ª–æ–≥
- **–°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π FUSER –Ω–∞ –æ—Å–Ω–æ–≤–µ fingerprint'–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å  
- **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±—ä–µ–∫—Ç–µ**: `$this->basket` –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
- **–ú–∏–Ω–∏–º—É–º SQL**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã INSERT/UPDATE
- **–°–µ—Å—Å–∏–æ–Ω–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î

## üö® –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ FUSER
tail -f /local/logs/fuser_debug.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ë–î
SELECT * FROM b_sale_fuser WHERE SESSION_ID = 'session_id';
SELECT * FROM b_sale_basket WHERE FUSER_ID = 123;
```

### –¢–æ–≤–∞—Ä—ã –∏—Å—á–µ–∑–∞—é—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ FUSER**: –õ–æ–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `real_fuser_id > 0`
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é**: `$_SESSION['BX_SALE_REAL_FUSER']` –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookies**: –ë—Ä–∞—É–∑–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å `PHPSESSID`

### –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏**: `SELECT * FROM b_sale_delivery;`
- **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã**: `SELECT * FROM b_sale_pay_system;`
- **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–∞**: –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Postman –∫–æ–ª–ª–µ–∫—Ü–∏—è - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª
```javascript
// 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
POST /api/basket
{
  "product_id": 8193,
  "quantity": 2
}

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã  
GET /api/basket

// 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
PATCH /api/basket  
{
  "basket_item_id": "{{item_id}}",
  "quantity": 3
}

// 4. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
POST /api/order_create
{
  "name": "Test User",
  "phone": "+79991234567", 
  "email": "test@example.com"
}

// 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
GET /api/basket
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
1. **–ü–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è**: –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä ‚Üí –ü–æ–ª—É—á–∏—Ç—å FUSER_ID
2. **–ó–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä** (–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å cookie)  
3. **–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è**: –û—Ç–∫—Ä—ã—Ç—å ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É ‚Üí –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å FUSER_ID**: –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ç–µ–º –∂–µ

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è**: 100+ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏**: –†–∞–∑–Ω—ã–µ FUSER_ID –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è
- **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö FUSER**: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### JavaScript SDK
```javascript
class BasketAPI {
  static baseURL = '/api';
  
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  static async addProduct(productId, quantity = 1, properties = []) {
    const response = await fetch(`${this.baseURL}/basket`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        product_id: productId,
        quantity: quantity,
        properties: properties
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return response.json();
  }
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
  static async getBasket() {
    const response = await fetch(`${this.baseURL}/basket`);
    return response.json();
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
  static async updateQuantity(basketItemId, quantity) {
    const response = await fetch(`${this.baseURL}/basket`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        basket_item_id: basketItemId,
        quantity: quantity
      })
    });
    return response.json();
  }
  
  // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  static async removeItem(basketItemId) {
    const response = await fetch(`${this.baseURL}/basket`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        basket_item_id: basketItemId
      })
    });
    return response.json();
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  static async createOrder(userData) {
    const response = await fetch(`${this.baseURL}/order_create`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(userData)
    });
    return response.json();
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
try {
  const result = await BasketAPI.addProduct(8193, 2);
  console.log('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω:', result);
} catch (error) {
  console.error('–û—à–∏–±–∫–∞:', error);
}
```

### React Hook –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
```javascript
import { useState, useEffect } from 'react';

export function useBasket() {
  const [basket, setBasket] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const loadBasket = async () => {
    setLoading(true);
    try {
      const data = await BasketAPI.getBasket();
      setBasket(data.basket);
      setError(null);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const addProduct = async (productId, quantity = 1) => {
    try {
      await BasketAPI.addProduct(productId, quantity);
      await loadBasket(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    } catch (err) {
      setError(err.message);
    }
  };

  useEffect(() => {
    loadBasket();
  }, []);

  return {
    basket,
    loading,
    error,
    addProduct,
    loadBasket
  };
}
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –ë–î —á–µ—Ä–µ–∑ FUSER_ID
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞**: localStorage –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É
- **Offline handling**: –ü–æ–∫–∞–∑ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Ç–∏

## ‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ—Ä–∑–∏–Ω
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω
SELECT 
  COUNT(*) as active_baskets,
  SUM(QUANTITY) as total_items,
  DATE(DATE_INSERT) as date
FROM b_sale_basket 
WHERE ORDER_ID IS NULL 
GROUP BY DATE(DATE_INSERT);

-- –°—Ç–∞—Ä—ã–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ FUSER
SELECT * FROM b_sale_fuser 
WHERE DATE_UPDATE < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
DELETE b FROM b_sale_basket b
JOIN b_sale_fuser f ON b.FUSER_ID = f.ID  
WHERE b.ORDER_ID IS NULL 
AND f.DATE_UPDATE < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö FUSER
DELETE FROM b_sale_fuser 
WHERE DATE_UPDATE < DATE_SUB(NOW(), INTERVAL 30 DAY)
AND ID NOT IN (SELECT DISTINCT FUSER_ID FROM b_sale_basket);
```

---
**–°–æ–∑–¥–∞–Ω–æ**: 28.05.2025  
**–í–µ—Ä—Å–∏—è**: 2.0 (Critical Fix Edition)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
```
